{% extends 'admin/custom_admin_base.html' %}

{% block title %}Dashboard{% endblock %}

{% block page_title %}
    <div class="flex justify-between items-center w-full">
        <span>Dashboard Visão Geral</span>
        <a href="{{ url_for('custom_news_form') }}" class="bg-primary hover:bg-blue-800 text-white font-bold py-2 px-4 rounded inline-flex items-center transition-colors duration-200">
            <i class="fas fa-plus mr-2"></i>
            <span>Nova Notícia</span>
        </a>
    </div>
{% endblock %}


{% block content %}
<!-- Cards de Estatísticas -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Card Total de Notícias -->
    <div class="bg-dark-secondary p-6 rounded-lg shadow-lg">
        <div class="flex items-center">
            <div class="bg-blue-500 bg-opacity-20 p-3 rounded-full">
                <i class="fas fa-newspaper fa-lg text-blue-400"></i>
            </div>
            <div class="ml-4">
                <p class="text-gray-400">Total de Notícias</p>
                <p class="text-2xl font-bold text-white">{{ stats.news | default('0') }}</p>
            </div>
        </div>
    </div>
    <!-- Card Comentários Pendentes -->
    <div class="bg-dark-secondary p-6 rounded-lg shadow-lg">
        <div class="flex items-center">
            <div class="bg-green-500 bg-opacity-20 p-3 rounded-full">
                <i class="fas fa-comments fa-lg text-green-400"></i>
            </div>
            <div class="ml-4">
                <p class="text-gray-400">Comentários Pendentes</p>
                <p class="text-2xl font-bold text-white">{{ stats.pending_comments | default('0') }}</p>
            </div>
        </div>
    </div>
    <!-- Card Visualizações Totais (Estático por enquanto) -->
    <div class="bg-dark-secondary p-6 rounded-lg shadow-lg">
        <div class="flex items-center">
            <div class="bg-yellow-500 bg-opacity-20 p-3 rounded-full">
                <i class="fas fa-eye fa-lg text-yellow-400"></i>
            </div>
            <div class="ml-4">
                <p class="text-gray-400">Visualizações Totais</p>
                <p class="text-2xl font-bold text-white">12,345</p>
            </div>
        </div>
    </div>
    <!-- Card Total de Usuários -->
    <div class="bg-dark-secondary p-6 rounded-lg shadow-lg">
        <div class="flex items-center">
            <div class="bg-red-500 bg-opacity-20 p-3 rounded-full">
                <i class="fas fa-users fa-lg text-red-400"></i>
            </div>
            <div class="ml-4">
                <p class="text-gray-400">Total de Usuários</p>
                <p class="text-2xl font-bold text-white">{{ stats.users | default('0') }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
    <div class="lg:col-span-3 bg-dark-secondary p-6 rounded-lg shadow-lg">
        <h3 class="text-lg font-bold mb-4">Visualizações da Semana</h3>
        <div class="bg-dark-tertiary h-64 flex items-center justify-center rounded-md">
            <p class="text-gray-400">Gráfico de Linha Aqui</p>
        </div>
    </div>
    <div class="lg:col-span-2 bg-dark-secondary p-6 rounded-lg shadow-lg">
        <h3 class="text-lg font-bold mb-4">Notícias por Status</h3>
        <div class="h-64 flex items-center justify-center rounded-md">
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

<!-- Tabelas de Atividade Recente -->
<div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <!-- Notícias Recentes -->
    <div class="bg-dark-secondary p-6 rounded-lg shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">Notícias Recentes</h3>
            <a href="{{ url_for('custom_news_list') }}" class="text-sm text-blue-400 hover:underline">Ver todas</a>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                    <tr class="text-gray-400 border-b border-dark-tertiary">
                        <th class="py-2">Título</th>
                        <th class="py-2">Status</th>
                        <th class="py-2">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% if stats.recent_news %}
                        {% for news_item in stats.recent_news %}
                        <tr class="border-b border-dark-tertiary hover:bg-dark-tertiary">
                            <td class="py-3 pr-2">{{ news_item.title | truncate(40) }}</td>
                            <td class="py-3 px-2">
                                {% if news_item.status == 'published' %}
                                    <span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">Publicado</span>
                                {% elif news_item.status == 'draft' %}
                                    <span class="px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full">Rascunho</span>
                                {% else %}
                                    <span class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-400 rounded-full">{{ news_item.status | capitalize }}</span>
                                {% endif %}
                            </td>
                            <td class="py-3 pl-2 text-right">
                                <a href="{{ url_for('custom_news_form', id=news_item.id) }}" class="text-gray-400 hover:text-white" title="Editar">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="3" class="py-4 text-center text-gray-500">Nenhuma notícia recente.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Comentários Recentes -->
    <div class="bg-dark-secondary p-6 rounded-lg shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">Comentários Recentes</h3>
            <a href="{{ url_for('comment.index_view') }}" class="text-sm text-blue-400 hover:underline">Ver todos</a>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                    <tr class="text-gray-400 border-b border-dark-tertiary">
                        <th class="py-2">Autor</th>
                        <th class="py-2">Comentário</th>
                        <th class="py-2">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% if stats.recent_comments %}
                        {% for comment in stats.recent_comments %}
                        <tr class="border-b border-dark-tertiary hover:bg-dark-tertiary">
                            <td class="py-3 pr-2">{{ comment.author_name | truncate(15) }}</td>
                            <td class="py-3 px-2 text-gray-400">"{{ comment.content | truncate(25) }}"</td>
                            <td class="py-3 pl-2">
                                {% if comment.approved %}
                                    <span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">Aprovado</span>
                                {% else %}
                                    <span class="px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full">Pendente</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="3" class="py-4 text-center text-gray-500">Nenhum comentário recente.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const statusChartCanvas = document.getElementById('statusChart');
    if (!statusChartCanvas) {
        return;
    }
    const ctx = statusChartCanvas.getContext('2d');
    
    const newsByStatus = {{ stats.news_by_status | tojson }};

    const labels = Object.keys(newsByStatus);
    const data = Object.values(newsByStatus);

    if (data.length === 0 || data.every(item => item === 0)) {
        const parentDiv = statusChartCanvas.parentNode;
        parentDiv.innerHTML = '<p class="text-gray-400 text-center">Nenhum dado de status para exibir.</p>';
        return;
    }

    const statusColors = {
        'published': 'rgba(34, 197, 94, 0.7)',
        'draft': 'rgba(234, 179, 8, 0.7)',
        'scheduled': 'rgba(107, 114, 128, 0.7)'
    };
    const backgroundColors = labels.map(label => statusColors[label] || statusColors['draft']);

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)), // Capitalizar
            datasets: [{
                label: 'Notícias',
                data: data,
                backgroundColor: backgroundColors,
                borderColor: '#1F2937', // Cor de fundo do card
                borderWidth: 2,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#D1D5DB', // Cor do texto da legenda
                        font: {
                            family: 'Inter',
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += context.parsed;
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %} 